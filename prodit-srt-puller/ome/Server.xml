<?xml version="1.0" encoding="UTF-8"?>

<Server version="8">
    <Name>OvenMediaEngine-POC</Name>
    <!-- Host type (origin/edge) -->
    <Type>origin</Type>
    <!-- Specify IP address to bind ("*" means all IPv4 IPs, "::" means all IPv6 IPs) -->
    <IP>*</IP>
    <PrivacyProtection>false</PrivacyProtection>

    <StunServer>stun.ovenmediaengine.com:13478</StunServer>

    <Modules>
        <HTTP2>
            <Enable>true</Enable>
        </HTTP2>

        <LLHLS>
            <Enable>true</Enable>
        </LLHLS>

        <P2P>
            <Enable>false</Enable>
            <MaxClientPeersPerHostPeer>2</MaxClientPeersPerHostPeer>
        </P2P>
    </Modules>

    <!-- Settings for the ports to bind -->
    <Bind>
        <Providers>
            <!-- Pull providers -->
            <RTSPC>
                <WorkerCount>1</WorkerCount>
            </RTSPC>
            <OVT>
                <WorkerCount>1</WorkerCount>
            </OVT>
            <!-- Push providers -->
            <RTMP>
                <Port>1935</Port>
                <WorkerCount>1</WorkerCount>
            </RTMP>
            <SRT>
                <Port>9999</Port>
                <WorkerCount>1</WorkerCount>
            </SRT>
            <MPEGTS>
                <Port>4000/udp</Port>
            </MPEGTS>
            <WebRTC>
                <Signalling>
                    <Port>3333</Port>
                    <TLSPort>3334</TLSPort>
                    <WorkerCount>1</WorkerCount>
                </Signalling>

                <IceCandidates>
                    <IceCandidate>*:10000-10004/udp</IceCandidate>
                    <TcpRelay>*:3478</TcpRelay>
                    <TcpForce>true</TcpForce>
                    <TcpRelayWorkerCount>1</TcpRelayWorkerCount>
                </IceCandidates>
            </WebRTC>
        </Providers>

        <Publishers>
            <OVT>
                <Port>9000</Port>
                <WorkerCount>1</WorkerCount>
            </OVT>
            <LLHLS>
                <Port>3333</Port>
                <TLSPort>3334</TLSPort>
                <WorkerCount>1</WorkerCount>
            </LLHLS>
            <WebRTC>
                <Signalling>
                    <Port>3333</Port>
                    <TLSPort>3334</TLSPort>
                    <WorkerCount>1</WorkerCount>
                </Signalling>
                <IceCandidates>
                    <IceCandidate>*:10000-10004/udp</IceCandidate>
                    <TcpRelay>*:3478</TcpRelay>
                    <TcpForce>true</TcpForce>
                    <TcpRelayWorkerCount>1</TcpRelayWorkerCount>
                </IceCandidates>
            </WebRTC>
            <!-- SRT LISTENER (output) -->
            <SRT>
                <Port>9998</Port>
                <WorkerCount>1</WorkerCount>
            </SRT>
        </Publishers>
    </Bind>

    <VirtualHosts>
        <VirtualHost>
            <Name>default</Name>
            <Distribution>ovenmediaengine.com</Distribution>

            <Host>
                <Names>
                    <Name>*</Name>
                </Names>
            </Host>

            <!-- Default CORS Settings -->
            <CrossDomains>
                <Url>*</Url>
            </CrossDomains>

            <!-- Settings for applications -->
            <Applications>
                <Application>
                    <Name>app</Name>
                    <!-- Application type (live/vod) -->
                    <Type>live</Type>

                    <OutputProfiles>
                        <!-- Common setting for decoders. -->
                        <Decodes>
                            <ThreadCount>2</ThreadCount>
                            <OnlyKeyframes>false</OnlyKeyframes>
                        </Decodes>

                        <HardwareAcceleration>true</HardwareAcceleration>

                        <!-- HWAccels: uključen NVENC -->
                        <HWAccels>
                            <Decoder>
                                <Enable>false</Enable>
                               <!--  <Modules>nv</Modules> -->
                            </Decoder>
                            <Encoder>
                                <Enable>true</Enable>
                                <Modules>nv</Modules>
                            </Encoder>
                        </HWAccels>

                        <OutputProfile>
                            <Name>bypass_stream</Name>
                            <OutputStreamName>${OriginStreamName}</OutputStreamName>

                            <!-- MASTER PLAYLIST (ABR) -->
                            <Playlist>
                                <Name>default</Name>
                                <FileName>master</FileName>
                                <Options>
                                    <WebRtcAutoAbr>true</WebRtcAutoAbr>
                                    <HLSChunklistPathDepth>0</HLSChunklistPathDepth>
                                    <EnableTsPackaging>true</EnableTsPackaging>
                                </Options>

                                <!-- Template: uzima sve enkodirane/bypassed video/audio i pravi ABR -->
                                <RenditionTemplate>
                                    <Name>${Height}p</Name>
                                    <VideoTemplate>
                                        <EncodingType>all</EncodingType>
                                    </VideoTemplate>
                                    <AudioTemplate>
                                        <EncodingType>all</EncodingType>
                                    </AudioTemplate>
                                </RenditionTemplate>
                            </Playlist>

                            <Encodes>
                                <!-- AUDIO: AAC ONLY -->
                                <Audio>
                                    <Name>aac_audio</Name>
                                    <Codec>aac</Codec>
                                    <Bitrate>128000</Bitrate>
                                    <Samplerate>48000</Samplerate>
                                    <Channel>2</Channel>
                                    <BypassIfMatch>
                                        <Codec>eq</Codec>
                                    </BypassIfMatch>
                                </Audio>
                            
                                <!-- VIDEO LADDER – NVENC -->
                                <!-- 1080p -->
                                <Video>
                                    <Name>video_1080</Name>
                                    <Codec>h264</Codec>
                                    <Bitrate>6000000</Bitrate>
                                    <Width>1920</Width>
                                    <Height>1080</Height>
                                    <Framerate>25</Framerate>
                                    <KeyFrameInterval>50</KeyFrameInterval>
                                    <BFrames>0</BFrames>
                                    <Preset>faster</Preset>
                                </Video>
                            
                                <!-- 720p -->
                                <Video>
                                    <Name>video_720</Name>
                                    <Codec>h264</Codec>
                                    <Bitrate>3000000</Bitrate>
                                    <Width>1280</Width>
                                    <Height>720</Height>
                                    <Framerate>25</Framerate>
                                    <KeyFrameInterval>50</KeyFrameInterval>
                                    <BFrames>0</BFrames>
                                    <Preset>faster</Preset>
                                </Video>
                            
                                <!-- 512p -->
                                <Video>
                                    <Name>video_512</Name>
                                    <Codec>h264</Codec>
                                    <Bitrate>1500000</Bitrate>
                                    <Width>912</Width>
                                    <Height>512</Height>
                                    <Framerate>25</Framerate>
                                    <KeyFrameInterval>50</KeyFrameInterval>
                                    <BFrames>0</BFrames>
                                    <Preset>faster</Preset>
                                </Video>
                            </Encodes>
                        </OutputProfile>
                    </OutputProfiles>

                    <Providers>
                        <OVT />
                        <WebRTC />
                        <RTMP />
                        <SRT />
                        <MPEGTS>
                            <StreamMap>
                                <Stream>
                                    <Name>stream_${Port}</Name>
                                    <Port>4000</Port>
                                </Stream>
                            </StreamMap>
                        </MPEGTS>
                        <RTSPPull />
                        <WebRTC>
                            <Timeout>30000</Timeout>
                            <CrossDomains>
                                <Url>*</Url>
                            </CrossDomains>
                        </WebRTC>
                        <Schedule>
                            <MediaRootDir>/opt/ovenmediaengine/media</MediaRootDir>
                            <ScheduleFilesDir>/opt/ovenmediaengine/media</ScheduleFilesDir>
                        </Schedule>
                    </Providers>

                    <Publishers>
                        <AppWorkerCount>1</AppWorkerCount>
                        <StreamWorkerCount>8</StreamWorkerCount>

                        <OVT />
                        <WebRTC>
                            <Timeout>30000</Timeout>
                            <Rtx>false</Rtx>
                            <Ulpfec>false</Ulpfec>
                            <JitterBuffer>false</JitterBuffer>
                            <CreateDefaultPlaylist>true</CreateDefaultPlaylist>
                        </WebRTC>

                        <LLHLS>
                            <ChunkDuration>0.5</ChunkDuration>
                            <PartHoldBack>1.5</PartHoldBack>
                            <SegmentDuration>6</SegmentDuration>
                            <SegmentCount>10</SegmentCount>
                            <DVR>
                                <Enable>false</Enable>
                                <TempStoragePath>/tmp/ome_dvr/</TempStoragePath>
                                <MaxDuration>3600</MaxDuration>
                            </DVR>
                            <CrossDomains>
                                <Url>*</Url>
                            </CrossDomains>
                            <CreateDefaultPlaylist>true</CreateDefaultPlaylist>
                        </LLHLS>

                        <HLS>
                            <SegmentCount>4</SegmentCount>
                            <SegmentDuration>4</SegmentDuration>
                            <CrossDomains>
                                <Url>*</Url>
                            </CrossDomains>
                            <CreateDefaultPlaylist>true</CreateDefaultPlaylist>
                        </HLS>

                        <!-- SRT publisher (listener) za playback -->
                        <SRT />

                    </Publishers>
                </Application>
            </Applications>
        </VirtualHost>
    </VirtualHosts>
</Server>
